{% extends "base.html" %}

{% block title %}Chat Dataset Analyzer{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-upload"></i> Chat Message Dataset Analyzer</h2>
                    <p class="text-muted">Upload a CSV file containing chat messages to analyze toxicity patterns and generate comprehensive reports</p>
                </div>
                <div class="card-body">
                    
                    <!-- Upload Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h4>Upload Chat Dataset</h4>
                                    <p class="text-muted">Drag & drop your CSV file here or click to browse</p>
                                    <input type="file" id="fileInput" accept=".csv" class="d-none" aria-label="Upload file">
                                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-folder-open"></i> Choose File
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-panel">
                                <h5><i class="fas fa-info-circle"></i> Dataset Requirements</h5>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> CSV format (.csv)</li>
                                    <li><i class="fas fa-check text-success"></i> Contains text messages/chat content</li>
                                    <li><i class="fas fa-check text-success"></i> Column names: message, text, content, chat, or msg</li>
                                    <li><i class="fas fa-check text-success"></i> Maximum 10MB file size</li>
                                </ul>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Sample format:</strong><br>
                                        message,user,timestamp<br>
                                        "Hello everyone!",user1,2024-01-01<br>
                                        "This is a test message",user2,2024-01-01
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div id="progressSection" class="mb-4" d-none">
                        <div class="card">
                            <div class="card-body">
                                <h5><i class="fas fa-cog fa-spin"></i> Analyzing Dataset...</h5>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" id="progressBar"></div>
                                </div>
                                <p class="text-muted mt-2" id="progressText">Uploading file...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection" class="d-none">
                        
                        <!-- Summary Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card bg-primary">
                                    <div class="stat-icon">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h3 id="totalMessages">0</h3>
                                        <p>Total Messages</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-danger">
                                    <div class="stat-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h3 id="toxicMessages">0</h3>
                                        <p>Toxic Messages</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-warning">
                                    <div class="stat-icon">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h3 id="toxicPercentage">0%</h3>
                                        <p>Toxicity Rate</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card bg-info">
                                    <div class="stat-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="stat-content">
                                        <h3 id="avgScore">0.0</h3>
                                        <p>Avg Toxicity Score</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts and Analysis -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-pie"></i> Toxicity Categories</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-bar"></i> Severity Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="severityChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sample Results Table -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-table"></i> Sample Analysis Results</h5>
                                <small class="text-muted">Showing first 20 analyzed messages</small>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="resultsTable">
                                        <thead>
                                            <tr>
                                                <th>Message</th>
                                                <th>Toxicity Score</th>
                                                <th>Status</th>
                                                <th>Categories</th>
                                                <th>Severity</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Export Options -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5><i class="fas fa-download"></i> Export Results</h5>
                            </div>
                            <div class="card-body">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" onclick="exportResults('csv')">
                                        <i class="fas fa-file-csv"></i> Export CSV
                                    </button>
                                    <button class="btn btn-primary" onclick="exportResults('json')">
                                        <i class="fas fa-file-code"></i> Export JSON
                                    </button>
                                    <button class="btn btn-info" onclick="generateReport()">
                                        <i class="fas fa-file-alt"></i> Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #0056b3;
    background: #e3f2fd;
}

.upload-area.dragover {
    border-color: #28a745;
    background: #d4edda;
}

.info-panel {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    height: 100%;
}

.stat-card {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary));
    color: white;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.stat-card.bg-primary { background: linear-gradient(135deg, #007bff, #0056b3) !important; }
.stat-card.bg-danger { background: linear-gradient(135deg, #dc3545, #c82333) !important; }
.stat-card.bg-warning { background: linear-gradient(135deg, #ffc107, #e0a800) !important; }
.stat-card.bg-info { background: linear-gradient(135deg, #17a2b8, #138496) !important; }

.stat-icon {
    font-size: 2rem;
    margin-right: 15px;
    opacity: 0.8;
}

.stat-content h3 {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
}

.stat-content p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.9;
}
</style>

<script>
let analysisResults = null;

// File upload handling
document.getElementById('fileInput').addEventListener('change', handleFileUpload);

// Drag and drop handling
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

uploadArea.addEventListener('click', () => {
    document.getElementById('fileInput').click();
});

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        handleFile(file);
    }
}

function handleFile(file) {
    if (!file.name.endsWith('.csv')) {
        alert('Please select a CSV file');
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) { // 10MB
        alert('File size must be less than 10MB');
        return;
    }
    
    uploadAndAnalyze(file);
}

function uploadAndAnalyze(file) {
    const progressSection = document.getElementById('progressSection');
    const resultsSection = document.getElementById('resultsSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // Show progress
    progressSection.style.display = 'block';
    resultsSection.style.display = 'none';
    
    // Simulate progress
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 30;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 200);
    
    // Upload file
    const formData = new FormData();
    formData.append('file', file);
    
    progressText.textContent = 'Uploading and analyzing dataset...';
    
    fetch('/upload-dataset', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        if (data.status === 'success') {
            progressText.textContent = 'Analysis complete!';
            setTimeout(() => {
                progressSection.style.display = 'none';
                displayResults(data);
            }, 1000);
        } else {
            progressText.textContent = 'Analysis failed: ' + data.error;
            progressBar.classList.add('bg-danger');
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        progressText.textContent = 'Upload failed: ' + error.message;
        progressBar.classList.add('bg-danger');
    });
}

function displayResults(data) {
    analysisResults = data;
    const summary = data.summary;
    const results = data.results;
    
    // Update statistics
    document.getElementById('totalMessages').textContent = summary.total_messages;
    document.getElementById('toxicMessages').textContent = summary.toxic_messages;
    document.getElementById('toxicPercentage').textContent = summary.toxic_percentage.toFixed(1) + '%';
    document.getElementById('avgScore').textContent = summary.average_toxicity_score.toFixed(2);
    
    // Update results table
    const tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = '';
    
    results.forEach(result => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td class="text-truncate" style="max-width: 300px;" title="${result.message}">${result.message}</td>
            <td><span class="badge ${result.toxicity_score > 0.5 ? 'bg-danger' : 'bg-success'}">${result.toxicity_score.toFixed(2)}</span></td>
            <td><span class="badge ${result.is_toxic ? 'bg-danger' : 'bg-success'}">${result.is_toxic ? 'Toxic' : 'Clean'}</span></td>
            <td>${result.categories.join(', ') || 'None'}</td>
            <td><span class="badge bg-info">${result.severity}</span></td>
        `;
    });
    
    // Create charts
    createCategoryChart(summary.category_breakdown);
    createSeverityChart(results);
    
    // Show results
    document.getElementById('resultsSection').style.display = 'block';
}

function createCategoryChart(categories) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createSeverityChart(results) {
    const severityCounts = {};
    results.forEach(result => {
        severityCounts[result.severity] = (severityCounts[result.severity] || 0) + 1;
    });
    
    const ctx = document.getElementById('severityChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(severityCounts),
            datasets: [{
                label: 'Message Count',
                data: Object.values(severityCounts),
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function exportResults(format) {
    if (!analysisResults) {
        alert('No results to export');
        return;
    }
    
    // Create download link
    const data = format === 'csv' ? convertToCSV(analysisResults) : JSON.stringify(analysisResults, null, 2);
    const blob = new Blob([data], { type: format === 'csv' ? 'text/csv' : 'application/json' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `toxicity_analysis_results.${format}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function convertToCSV(data) {
    const results = data.results;
    let csv = 'Index,Message,Toxicity Score,Is Toxic,Categories,Severity\n';
    
    results.forEach(result => {
        csv += `${result.index},"${result.message.replace(/"/g, '""')}",${result.toxicity_score},${result.is_toxic},"${result.categories.join('; ')}",${result.severity}\n`;
    });
    
    return csv;
}

function generateReport() {
    if (!analysisResults) {
        alert('No results available for report generation');
        return;
    }
    
    // Generate comprehensive report
    const summary = analysisResults.summary;
    let report = `# Toxicity Analysis Report\n\n`;
    report += `**Dataset:** ${summary.dataset_info.filename}\n`;
    report += `**Analysis Date:** ${new Date().toLocaleString()}\n\n`;
    report += `## Summary Statistics\n\n`;
    report += `- **Total Messages Analyzed:** ${summary.total_messages}\n`;
    report += `- **Toxic Messages:** ${summary.toxic_messages}\n`;
    report += `- **Toxicity Rate:** ${summary.toxic_percentage.toFixed(1)}%\n`;
    report += `- **Average Toxicity Score:** ${summary.average_toxicity_score.toFixed(2)}\n\n`;
    report += `## Category Breakdown\n\n`;
    
    Object.entries(summary.category_breakdown).forEach(([category, count]) => {
        report += `- **${category}:** ${count} messages\n`;
    });
    
    report += `\n## Recommendations\n\n`;
    if (summary.toxic_percentage > 20) {
        report += `- **High toxicity detected** (${summary.toxic_percentage.toFixed(1)}%) - Consider implementing content moderation\n`;
    } else if (summary.toxic_percentage > 10) {
        report += `- **Moderate toxicity detected** (${summary.toxic_percentage.toFixed(1)}%) - Monitor conversations closely\n`;
    } else {
        report += `- **Low toxicity detected** (${summary.toxic_percentage.toFixed(1)}%) - Community appears healthy\n`;
    }
    
    // Download report
    const blob = new Blob([report], { type: 'text/markdown' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'toxicity_analysis_report.md';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}