<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Live Toxicity Dashboard</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        position: relative;
        overflow: hidden;
        transition: transform 0.3s;
      }
      
      .metric-card:hover {
        transform: translateY(-5px);
      }
      
      .metric-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse 3s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }
      
      .metric-value {
        font-size: 48px;
        font-weight: 800;
        margin: 10px 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }
      
      .metric-label {
        font-size: 14px;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      .metric-icon {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 48px;
        opacity: 0.2;
      }
      
      .chart-container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }
      
      .chart-container h3 {
        margin-top: 0;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #10b981;
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        animation: pulse-live 2s infinite;
      }
      
      .live-indicator::before {
        content: '';
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: blink 1.5s infinite;
      }
      
      @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }
      
      @keyframes pulse-live {
        0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      }
      
      .alert-banner {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        animation: slideInDown 0.5s;
      }
      
      @keyframes slideInDown {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .heatmap-cell {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin: 2px;
        border-radius: 4px;
        transition: all 0.3s;
        cursor: pointer;
      }
      
      .heatmap-cell:hover {
        transform: scale(1.2);
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
      }
      
      .activity-feed {
        max-height: 400px;
        overflow-y: auto;
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
      }
      
      .activity-item {
        background: white;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 4px solid #3b82f6;
        animation: fadeIn 0.5s;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      .gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
      .gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
      .gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
      .gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
      .gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
      .gradient-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
      
      .header-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      
      .alert-icon {
        font-size: 24px;
      }
      
      .alert-text {
        margin: 5px 0 0 0;
        font-size: 14px;
      }
      
      .metric-subtitle {
        font-size: 12px;
        opacity: 0.8;
      }
      
      .charts-row-main {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .charts-row-equal {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .heatmap-centered {
        text-align: center;
        padding: 20px;
      }
      
      .feed-empty {
        text-align: center;
        color: #9ca3af;
        padding: 40px;
      }
      
      .feed-icon {
        font-size: 36px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">ðŸ“Š Live Toxicity Dashboard</div>
      <nav>
        <a href="/"><i class="fas fa-home"></i> Home</a>
        <a href="/chat-analyzer"><i class="fas fa-comment"></i> Chat Analyzer</a>
        <a href="/live-dashboard" class="active"><i class="fas fa-chart-pie"></i> Live Dashboard</a>
        <a href="/dataset-analyzer"><i class="fas fa-database"></i> Dataset Analyzer</a>
        <a href="/comparison"><i class="fas fa-balance-scale"></i> Comparison</a>
        <a href="/analytics"><i class="fas fa-chart-line"></i> Analytics</a>
        <a href="/batch"><i class="fas fa-layer-group"></i> Batch</a>
        <a href="/models"><i class="fas fa-brain"></i> Models</a>
        <a href="/help"><i class="fas fa-question-circle"></i> Help</a>
      </nav>
    </header>

    <main class="container">
      <div class="header-flex">
        <div>
          <h1>Live Monitoring Dashboard</h1>
          <p class="muted">Real-time toxicity analytics and trends</p>
        </div>
        <div class="live-indicator">LIVE</div>
      </div>

      <!-- Alert Banner (shown only when high toxicity detected) -->
      <div id="alert-banner" class="d-none alert-banner">
        <i class="fa fa-exclamation-triangle alert-icon"></i>
        <div>
          <strong>High Toxicity Alert!</strong>
          <p class="alert-text">Multiple high-risk messages detected in the last 5 minutes</p>
        </div>
      </div>

      <!-- Metric Cards -->
      <div class="dashboard-grid">
        <div class="metric-card gradient-1">
          <i class="fa fa-messages metric-icon"></i>
          <div class="metric-label">Total Messages</div>
          <div class="metric-value" id="total-messages">0</div>
          <div class="metric-subtitle">Last 24 hours</div>
        </div>

        <div class="metric-card gradient-2">
          <i class="fa fa-exclamation-circle metric-icon"></i>
          <div class="metric-label">Toxic Messages</div>
          <div class="metric-value" id="toxic-count">0</div>
          <div class="metric-subtitle"><span id="toxic-percent">0</span>% of total</div>
        </div>

        <div class="metric-card gradient-3">
          <i class="fa fa-chart-line metric-icon"></i>
          <div class="metric-label">Avg Toxicity Score</div>
          <div class="metric-value" id="avg-score">0</div>
          <div class="metric-subtitle">Out of 100</div>
        </div>

        <div class="metric-card gradient-4">
          <i class="fa fa-shield-check metric-icon"></i>
          <div class="metric-label">Community Health</div>
          <div class="metric-value" id="health-score">100</div>
          <div class="metric-subtitle">Health Index</div>
        </div>

        <div class="metric-card gradient-5">
          <i class="fa fa-fire metric-icon"></i>
          <div class="metric-label">Toxicity Trend</div>
          <div class="metric-value" id="trend-indicator">â†’</div>
          <div class="metric-subtitle"><span id="trend-text">Stable</span></div>
        </div>

        <div class="metric-card gradient-6">
          <i class="fa fa-users metric-icon"></i>
          <div class="metric-label">Active Users</div>
          <div class="metric-value" id="active-users">0</div>
          <div class="metric-subtitle">Current session</div>
        </div>
      </div>

      <!-- Charts Row 1 -->
      <div class="charts-row-main">
        <div class="chart-container">
          <h3><i class="fa fa-chart-area"></i> Toxicity Timeline (Last Hour)</h3>
          <canvas id="timelineChart"></canvas>
        </div>

        <div class="chart-container">
          <h3><i class="fa fa-pie-chart"></i> Risk Distribution</h3>
          <canvas id="riskPieChart"></canvas>
        </div>
      </div>

      <!-- Charts Row 2 -->
      <div class="charts-row-equal">
        <div class="chart-container">
          <h3><i class="fa fa-layer-group"></i> Top Toxicity Categories</h3>
          <canvas id="categoriesChart"></canvas>
        </div>

        <div class="chart-container">
          <h3><i class="fa fa-clock"></i> Hourly Activity Heatmap</h3>
          <div id="heatmap-container" class="heatmap-centered"></div>
        </div>
      </div>

      <!-- Activity Feed -->
      <div class="chart-container">
        <h3><i class="fa fa-stream"></i> Live Activity Feed</h3>
        <div class="activity-feed" id="activity-feed">
          <div class="feed-empty">
            <i class="fa fa-satellite-dish feed-icon"></i>
            <p>Waiting for live activity...</p>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Initialize charts
      const timelineCtx = document.getElementById('timelineChart').getContext('2d');
      const riskPieCtx = document.getElementById('riskPieChart').getContext('2d');
      const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');

      // Timeline Chart
      const timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Toxicity Score',
            data: [],
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });

      // Risk Pie Chart
      const riskPieChart = new Chart(riskPieCtx, {
        type: 'doughnut',
        data: {
          labels: ['Safe', 'Low', 'Medium', 'High', 'Severe'],
          datasets: [{
            data: [0, 0, 0, 0, 0],
            backgroundColor: ['#10b981', '#84cc16', '#f59e0b', '#f97316', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Categories Bar Chart
      const categoriesChart = new Chart(categoriesCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Occurrences',
            data: [],
            backgroundColor: '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Generate hourly heatmap
      function generateHeatmap(data) {
        const container = document.getElementById('heatmap-container');
        container.innerHTML = '';
        
        const hours = 24;
        for (let i = 0; i < hours; i++) {
          const value = data[i] || 0;
          const intensity = Math.min(value / 10, 1);
          const color = `rgba(239, 68, 68, ${intensity})`;
          const cell = document.createElement('div');
          cell.className = 'heatmap-cell';
          cell.style.backgroundColor = color;
          cell.title = `${i}:00 - ${value.toFixed(1)} avg toxicity`;
          container.appendChild(cell);
        }
      }

      // Simulate real-time data updates
      let messageCount = 0;
      let toxicCount = 0;
      let totalScore = 0;
      const timelineData = [];
      const riskCounts = [0, 0, 0, 0, 0];
      const categoryData = {};
      const hourlyData = Array(24).fill(0);

      function updateDashboard() {
        // Simulate new message
        const isToxic = Math.random() > 0.7;
        const score = isToxic ? Math.floor(Math.random() * 60) + 40 : Math.floor(Math.random() * 30);
        
        messageCount++;
        if (score > 40) toxicCount++;
        totalScore += score;
        
        // Update metrics
        document.getElementById('total-messages').textContent = messageCount;
        document.getElementById('toxic-count').textContent = toxicCount;
        document.getElementById('toxic-percent').textContent = ((toxicCount / messageCount) * 100).toFixed(1);
        document.getElementById('avg-score').textContent = (totalScore / messageCount).toFixed(1);
        document.getElementById('health-score').textContent = (100 - (totalScore / messageCount)).toFixed(0);
        document.getElementById('active-users').textContent = Math.floor(messageCount / 5);
        
        // Update timeline
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();
        timelineData.push(score);
        if (timelineData.length > 20) timelineData.shift();
        
        timelineChart.data.labels = timelineData.map((_, i) => '');
        timelineChart.data.datasets[0].data = timelineData;
        timelineChart.update('none');
        
        // Update risk distribution
        const riskIndex = score < 15 ? 0 : score < 40 ? 1 : score < 60 ? 2 : score < 80 ? 3 : 4;
        riskCounts[riskIndex]++;
        riskPieChart.data.datasets[0].data = riskCounts;
        riskPieChart.update('none');
        
        // Update categories
        if (isToxic) {
          const categories = ['profanity', 'insult', 'threat', 'hate_speech', 'harassment'];
          const category = categories[Math.floor(Math.random() * categories.length)];
          categoryData[category] = (categoryData[category] || 0) + 1;
          
          const topCategories = Object.entries(categoryData)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          
          categoriesChart.data.labels = topCategories.map(c => c[0].replace(/_/g, ' '));
          categoriesChart.data.datasets[0].data = topCategories.map(c => c[1]);
          categoriesChart.update('none');
        }
        
        // Update hourly heatmap
        const hour = now.getHours();
        hourlyData[hour] = (hourlyData[hour] * 0.9) + (score * 0.1);
        generateHeatmap(hourlyData);
        
        // Update trend
        if (timelineData.length >= 10) {
          const recent = timelineData.slice(-5).reduce((a, b) => a + b, 0) / 5;
          const prev = timelineData.slice(-10, -5).reduce((a, b) => a + b, 0) / 5;
          const trend = recent > prev + 5 ? 'â†‘' : recent < prev - 5 ? 'â†“' : 'â†’';
          const trendText = recent > prev + 5 ? 'Increasing' : recent < prev - 5 ? 'Decreasing' : 'Stable';
          document.getElementById('trend-indicator').textContent = trend;
          document.getElementById('trend-text').textContent = trendText;
          
          // Show alert if increasing
          if (trend === 'â†‘' && recent > 50) {
            document.getElementById('alert-banner').style.display = 'flex';
            setTimeout(() => {
              document.getElementById('alert-banner').style.display = 'none';
            }, 5000);
          }
        }
        
        // Add activity feed item
        if (isToxic) {
          const feed = document.getElementById('activity-feed');
          if (feed.querySelector('.fa-satellite-dish')) {
            feed.innerHTML = '';
          }
          
          const item = document.createElement('div');
          item.className = 'activity-item';
          item.style.borderLeftColor = score > 70 ? '#ef4444' : score > 40 ? '#f59e0b' : '#3b82f6';
          item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span><i class="fa fa-warning" style="color: #ef4444;"></i> <strong>Toxic message detected</strong></span>
              <span style="font-size: 11px; color: #6b7280;">${timeLabel}</span>
            </div>
            <div style="font-size: 13px; color: #6b7280; margin-top: 5px;">
              Score: ${score}/100 | Risk: ${score > 70 ? 'HIGH' : score > 40 ? 'MEDIUM' : 'LOW'}
            </div>
          `;
          feed.insertBefore(item, feed.firstChild);
          
          // Keep only last 20 items
          while (feed.children.length > 20) {
            feed.removeChild(feed.lastChild);
          }
        }
      }

      // Initial heatmap
      generateHeatmap(hourlyData);
      
      // Update every 2 seconds (simulate real-time)
      setInterval(updateDashboard, 2000);
      
      // Initial update
      updateDashboard();
    </script>
  </body>
</html>
