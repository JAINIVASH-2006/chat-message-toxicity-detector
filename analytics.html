<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics Dashboard</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stat-card.green {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .stat-card.orange {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .stat-card.red {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .stat-value {
      font-size: 42px;
      font-weight: 800;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    
    .insight-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #3b82f6;
      margin: 15px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .insight-card.positive {
      border-left-color: #10b981;
      background: linear-gradient(to right, #ecfdf5, white);
    }
    
    .insight-card.warning {
      border-left-color: #f59e0b;
      background: linear-gradient(to right, #fffbeb, white);
    }
    
    .insight-card.info {
      border-left-color: #3b82f6;
      background: linear-gradient(to right, #eff6ff, white);
    }
    
    .insight-title {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    
    .insight-message {
      color: #6b7280;
      font-size: 14px;
    }
    
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 4px;
      margin: 20px 0;
    }
    
    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .heatmap-cell:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">üìä Analytics Dashboard</div>
    <nav>
      <a href="/"><i class="fas fa-home"></i> Home</a>
      <a href="/chat-analyzer"><i class="fas fa-comment"></i> Chat Analyzer</a>
      <a href="/live-dashboard"><i class="fas fa-chart-pie"></i> Live Dashboard</a>
      <a href="/dataset-analyzer"><i class="fas fa-database"></i> Dataset Analyzer</a>
      <a href="/comparison"><i class="fas fa-balance-scale"></i> Comparison</a>
      <a href="/analytics" class="active"><i class="fas fa-chart-line"></i> Analytics</a>
      <a href="/batch"><i class="fas fa-layer-group"></i> Batch</a>
      <a href="/models"><i class="fas fa-brain"></i> Models</a>
      <a href="/help"><i class="fas fa-question-circle"></i> Help</a>
    </nav>
  </header>

  <main class="container">
    <section>
      <h1>Historical Analytics & Trends</h1>
      <p class="muted">Deep insights into your community's communication patterns</p>
    </section>

    <div class="analytics-grid" id="stats-grid">
      <!-- Stats will be populated by JavaScript -->
    </div>

    <section class="chart-container">
      <h3>üìà 7-Day Toxicity Trend</h3>
      <canvas id="trend-chart"></canvas>
    </section>

    <div class="charts-grid-2col">
      <section class="chart-container">
        <h3>üéØ Category Distribution</h3>
        <canvas id="category-chart"></canvas>
      </section>

      <section class="chart-container">
        <h3>üïê Peak Hours Heatmap</h3>
        <div class="heatmap-grid" id="hours-heatmap"></div>
      </section>
    </div>

    <section class="card">
      <h3>üí° AI-Generated Insights</h3>
      <div id="insights-container"></div>
    </section>

    <section class="card card-top-margin">
      <h3>üìã Detailed Statistics</h3>
      <div id="detailed-stats"></div>
    </section>
  </main>

  <script>
    let trendChart, categoryChart;

    async function loadAnalytics() {
      try {
        const response = await fetch('/api/analytics');
        const data = await response.json();
        
        updateStatsCards(data.statistics);
        renderTrendChart(data.trends);
        renderCategoryChart(data.category_distribution);
        renderHoursHeatmap(data.peak_hours);
        renderInsights(data.insights);
        renderDetailedStats(data.statistics);
        
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    function updateStatsCards(stats) {
      const grid = document.getElementById('stats-grid');
      
      const avgColor = stats.avg_toxicity < 20 ? 'green' : 
                       stats.avg_toxicity < 50 ? 'orange' : 'red';
      
      grid.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">Total Analyzed</div>
          <div class="stat-value">${stats.total_analyzed.toLocaleString()}</div>
          <i class="fa fa-chart-line" style="font-size: 24px; opacity: 0.7;"></i>
        </div>
        
        <div class="stat-card ${avgColor}">
          <div class="stat-label">Average Toxicity</div>
          <div class="stat-value">${stats.avg_toxicity}/100</div>
          <i class="fa fa-gauge" style="font-size: 24px; opacity: 0.7;"></i>
        </div>
        
        <div class="stat-card ${stats.toxic_percentage < 10 ? 'green' : 'orange'}">
          <div class="stat-label">Toxic Rate</div>
          <div class="stat-value">${stats.toxic_percentage}%</div>
          <i class="fa fa-percentage" style="font-size: 24px; opacity: 0.7;"></i>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Most Common</div>
          <div class="stat-value" style="font-size: 24px;">${stats.most_common_level}</div>
          <i class="fa fa-star" style="font-size: 24px; opacity: 0.7;"></i>
        </div>
      `;
    }

    function renderTrendChart(trends) {
      const ctx = document.getElementById('trend-chart').getContext('2d');
      
      if (trendChart) trendChart.destroy();
      
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: trends.map(t => t.date),
          datasets: [
            {
              label: 'Average Toxicity',
              data: trends.map(t => t.avg_toxicity),
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Message Count',
              data: trends.map(t => t.count),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Toxicity Score'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Message Count'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    function renderCategoryChart(categories) {
      const ctx = document.getElementById('category-chart').getContext('2d');
      
      if (categoryChart) categoryChart.destroy();
      
      const sortedCats = Object.entries(categories)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      
      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sortedCats.map(c => c[0].replace(/_/g, ' ')),
          datasets: [{
            data: sortedCats.map(c => c[1]),
            backgroundColor: [
              '#ef4444', '#f97316', '#f59e0b', '#eab308',
              '#84cc16', '#22c55e', '#10b981', '#14b8a6'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
    }

    function renderHoursHeatmap(hours) {
      const container = document.getElementById('hours-heatmap');
      
      const maxToxic = Math.max(...Object.values(hours).map(h => h.toxic));
      
      let html = '';
      for (let hour = 0; hour < 24; hour++) {
        const data = hours[hour] || {total: 0, toxic: 0};
        const intensity = maxToxic > 0 ? data.toxic / maxToxic : 0;
        
        const color = `rgba(239, 68, 68, ${intensity})`;
        const bgColor = intensity === 0 ? '#f3f4f6' : color;
        
        html += `
          <div class="heatmap-cell" 
               style="background: ${bgColor}; color: ${intensity > 0.5 ? 'white' : '#374151'};"
               title="Hour ${hour}: ${data.toxic} toxic / ${data.total} total">
            ${hour}
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    function renderInsights(insights) {
      const container = document.getElementById('insights-container');
      
      if (!insights || insights.length === 0) {
        container.innerHTML = '<p class="muted">No insights available yet. Analyze more messages to generate insights.</p>';
        return;
      }
      
      container.innerHTML = insights.map(insight => `
        <div class="insight-card ${insight.type}">
          <div class="insight-title">
            ${insight.type === 'positive' ? '‚úÖ' : insight.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
            ${insight.title}
          </div>
          <div class="insight-message">${insight.message}</div>
        </div>
      `).join('');
    }

    function renderDetailedStats(stats) {
      const container = document.getElementById('detailed-stats');
      
      const levelDist = stats.level_distribution || {};
      
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <strong>Median Toxicity:</strong>
            <div style="font-size: 24px; color: #667eea; font-weight: 600;">${stats.median_toxicity}/100</div>
          </div>
          
          <div>
            <strong>Level Distribution:</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
              ${Object.entries(levelDist).map(([level, count]) => `
                <li>${level}: ${count} messages</li>
              `).join('')}
            </ul>
          </div>
        </div>
      `;
    }

    // Load analytics on page load
    loadAnalytics();

    // Auto-refresh every 30 seconds
    setInterval(loadAnalytics, 30000);
  </script>
</body>
</html>
