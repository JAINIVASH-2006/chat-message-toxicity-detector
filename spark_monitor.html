{% extends "base.html" %}

{% block title %}Spark Web UI Monitor - Toxicity Detector{% endblock %}

{% block content %}
<style>
  .spark-container {
    padding: 20px;
    max-width: 100%;
  }
  
  .spark-header {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3);
  }
  
  .spark-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.5em;
  }
  
  .spark-header p {
    margin: 0;
    opacity: 0.95;
    font-size: 1.1em;
  }
  
  .control-panel {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  
  .status-card {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
    margin-bottom: 20px;
  }
  
  .status-indicator {
    font-size: 48px;
  }
  
  .status-running {
    color: #10b981;
  }
  
  .status-stopped {
    color: #ef4444;
  }
  
  .status-info h3 {
    margin: 0 0 8px 0;
    color: #1e40af;
  }
  
  .status-info p {
    margin: 0;
    color: #6b7280;
  }
  
  .button-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  
  .spark-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .spark-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .btn-start {
    background: #10b981;
    color: white;
  }
  
  .btn-stop {
    background: #ef4444;
    color: white;
  }
  
  .btn-open {
    background: #6366f1;
    color: white;
  }
  
  .btn-refresh {
    background: #f59e0b;
    color: white;
  }
  
  .iframe-container {
    width: 100%;
    height: calc(100vh - 300px);
    min-height: 600px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    background: white;
  }
  
  .spark-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  
  .info-panel {
    background: #fffbeb;
    border: 2px solid #fbbf24;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .info-panel h3 {
    margin: 0 0 12px 0;
    color: #92400e;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .info-panel ul {
    margin: 10px 0;
    padding-left: 20px;
  }
  
  .info-panel li {
    margin: 8px 0;
    color: #78350f;
  }
  
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .action-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
  }
  
  .action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }
  
  .action-card h4 {
    margin: 0 0 10px 0;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .action-card p {
    margin: 0;
    color: #6b7280;
    font-size: 14px;
  }
</style>

<div class="spark-container">
  <div class="spark-header">
    <h1><i class="fas fa-fire"></i> Apache Spark Web UI Monitor</h1>
    <p>Real-time monitoring and management of distributed data processing jobs</p>
  </div>

  <div class="control-panel">
    <div class="status-card">
      <div class="status-indicator" id="status-icon">
        <i class="fas fa-circle-notch fa-spin"></i>
      </div>
      <div class="status-info">
        <h3 id="status-title">Checking Spark UI Status...</h3>
        <p id="status-description">Please wait while we connect to the Spark Web UI</p>
        <p class="spark-info-margin"><strong>Port:</strong> <span id="spark-port">4040</span></p>
        <p><strong>URL:</strong> <a href="http://localhost:4040" target="_blank" rel="noopener" id="spark-url">http://localhost:4040</a></p>
      </div>
    </div>

    <div class="button-group">
      <button class="spark-btn btn-start" id="btn-start" onclick="startSparkUI()">
        <i class="fas fa-play"></i> Start Spark UI
      </button>
      <button class="spark-btn btn-stop" id="btn-stop" onclick="stopSparkUI()">
        <i class="fas fa-stop"></i> Stop Spark UI
      </button>
      <button class="spark-btn btn-open" onclick="window.open('http://localhost:4040', '_blank')">
        <i class="fas fa-external-link-alt"></i> Open in New Tab
      </button>
      <button class="spark-btn btn-refresh" onclick="checkSparkStatus()">
        <i class="fas fa-sync-alt"></i> Refresh Status
      </button>
    </div>
  </div>

  <div class="info-panel">
    <h3><i class="fas fa-info-circle"></i> About Spark Web UI</h3>
    <p>The Spark Web UI provides detailed monitoring and debugging information for your Spark applications:</p>
    <ul>
      <li><strong>Jobs Tab:</strong> View all submitted jobs, their status, duration, and stages</li>
      <li><strong>Stages Tab:</strong> Detailed breakdown of each stage including tasks, shuffles, and metrics</li>
      <li><strong>Storage Tab:</strong> Information about cached RDDs and DataFrames</li>
      <li><strong>Environment Tab:</strong> Spark configuration and system properties</li>
      <li><strong>Executors Tab:</strong> Executor resources, metrics, and task distribution</li>
    </ul>
  </div>

  <div class="quick-actions">
    <div class="action-card" onclick="document.getElementById('run-spark-direct-btn')?.click()">
      <h4><i class="fas fa-bolt icon-orange"></i> Run Direct Job</h4>
      <p>Execute a Spark job on the persistent session - appears immediately in the UI</p>
    </div>
    <div class="action-card" onclick="document.getElementById('train-model-btn')?.click()">
      <h4><i class="fas fa-brain icon-green"></i> Train Model</h4>
      <p>Train a machine learning model using Spark MLlib</p>
    </div>
    <div class="action-card" onclick="window.location.href='/'">
      <h4><i class="fas fa-home icon-blue"></i> Go to Dashboard</h4>
      <p>Return to the main dashboard to start new analysis</p>
    </div>
  </div>

  <div class="iframe-container">
    <iframe id="spark-iframe" class="spark-iframe" src="/spark-proxy/" title="Spark Web UI"></iframe>
  </div>
</div>

<script>
let statusCheckInterval;

async function checkSparkStatus() {
  try {
    const response = await fetch('/spark-status');
    const data = await response.json();
    
    const statusIcon = document.getElementById('status-icon');
    const statusTitle = document.getElementById('status-title');
    const statusDescription = document.getElementById('status-description');
    const btnStart = document.getElementById('btn-start');
    const btnStop = document.getElementById('btn-stop');
    
    if (data.running) {
      statusIcon.innerHTML = '<i class="fas fa-check-circle status-running"></i>';
      statusIcon.className = 'status-indicator';
      statusTitle.textContent = 'Spark UI is Running';
      statusTitle.style.color = '#10b981';
      statusDescription.textContent = 'All systems operational. Jobs are being monitored in real-time.';
      btnStart.disabled = true;
      btnStart.style.opacity = '0.5';
      btnStop.disabled = false;
      btnStop.style.opacity = '1';
    } else {
      statusIcon.innerHTML = '<i class="fas fa-times-circle status-stopped"></i>';
      statusIcon.className = 'status-indicator';
      statusTitle.textContent = 'Spark UI is Stopped';
      statusTitle.style.color = '#ef4444';
      statusDescription.textContent = 'Spark UI is not currently running. Click "Start Spark UI" to begin monitoring.';
      btnStart.disabled = false;
      btnStart.style.opacity = '1';
      btnStop.disabled = true;
      btnStop.style.opacity = '0.5';
    }
  } catch (error) {
    console.error('Error checking Spark status:', error);
  }
}

async function startSparkUI() {
  const btn = document.getElementById('btn-start');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
  
  try {
    const response = await fetch('/spark-start', { method: 'POST' });
    const data = await response.json();
    
    setTimeout(() => {
      checkSparkStatus();
      // Reload iframe
      document.getElementById('spark-iframe').src = '/spark-proxy/';
    }, 2000);
  } catch (error) {
    console.error('Error starting Spark UI:', error);
    alert('Failed to start Spark UI: ' + error.message);
  } finally {
    btn.innerHTML = '<i class="fas fa-play"></i> Start Spark UI';
  }
}

async function stopSparkUI() {
  const btn = document.getElementById('btn-stop');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
  
  try {
    const response = await fetch('/spark-stop', { method: 'POST' });
    const data = await response.json();
    
    setTimeout(() => {
      checkSparkStatus();
    }, 1000);
  } catch (error) {
    console.error('Error stopping Spark UI:', error);
    alert('Failed to stop Spark UI: ' + error.message);
  } finally {
    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Spark UI';
  }
}

// Check status on page load
checkSparkStatus();

// Auto-refresh status every 10 seconds
statusCheckInterval = setInterval(checkSparkStatus, 10000);

// Cleanup interval on page unload
window.addEventListener('beforeunload', () => {
  clearInterval(statusCheckInterval);
});
</script>

{% endblock %}
